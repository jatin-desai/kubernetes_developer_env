# Configuration Settings


## Setup desktop

* Configure cntlm proxy if not already setup
  * ensure that it is listening on port 3128


* Configure docker
  - add proxy - http://docker.for.mac.host.internal:3128
  - add insecure registry - docker.for.mac.host.internal:5000


## Command-line Configuration

* ```SHP_HOME``` - Base service hosting platform folder - contains all git projects
  * in my case this is ```$HOME/sandbox/shp/gitrepo/```
      - service-platform-toolkit
      - service-platform-operations
      - shp-hsbc-utils
      - platform-example-spring


* ```SHP_DOMAIN_NAME``` - the base domain name for the kubernetes cluster
  * in my case this is ```local.service.platform```
    - Note: while this is specified as a config. param - there are additional dependencies that also need to be changed
    - For initial dev. purposes, please keep this unchanged


* ```SHP_DOCKER_REGISTRY``` - the docker registry to be used by the kubernetes cluster for pulling service images for Deployment
  * in my case this points to a docker registry running locally
    - ```docker.for.mac.host.internal:5000```
    - note: docker.for.mac.host.internal is the hostname that docker uses to point to the registry on localhost (on macs)


*  ```SHP_PROXY_URL``` - Proxy Settings for Internet Access
  * using cntlm proxy running on localhost
  * used by docker and minikube to pull images from internet


### Service Deployment

* ```SHP_BASE_REPO``` - the tag for base docker images
  * in my case this is 'digital'
    - this is the repository tag under which all base docker images are created
    - e.g. digital/shp-openjdk:8-jdk-alpine


* ```SHP_TEAM_NAME``` - used to create a namespace in Kubernetes to isolate deployments on a per team basis
  * e.g. ```tech``` - as a representation for the tp-engg. team
    - this is based on the granularity that needs to be used to define a *team*
    - this will also drive the sub-domain usage
    - all services for a given team will be deployed inside a common k8s namespace
    - all services for a given team will also share a common sub-domain
  * the default has been kept as ```play```
    - the k8s namespace is therefore - ```play```
    - the sub-domain is therefore - ```play.local.service.platform```


* ```SHP_TARGET_ENV``` - the env. that that application needs to be deployed to
  * ```local``` or ```dev``` or ```prod```
    - currently only for defining the docker registry to be used
    - not yet fully implemented / not tested
  * the default is ```local```


* ```APP_BASEFLDR``` - the base folder of the microservice containing the pom.xml file
  * this is used to load the application name, group id and version no.
  * the docker images for the app have the format : ```GROUP_ID/APP_NAME:VERSION_NO```



## Env. Configuration for Kube Deployments (service-platform-operations)

### ```base-config``` items

* ```env-config``` folder
  * externalized configuration related to the kube target environment that is configurable
    - docker registry url - ```shp_docker_registry```
    - default container and service ports - ```container_port``` and ```service_port```
    - pod instance counts - ```instance_count```


* ```kube-yamls``` folder
  * base kubernetes yamls to create Deployments, Services and Ingress rules
    - ```microservice-deployment.yml```
    - ```microservice-service.yml```
    - ```microservice-ingress.yml```
  * all application specific information is merged into these files at deploy time to generate runtime configuration
    - runtime configuration stored in the ```autogen-config``` folder

### ```user-config``` items
  * To enable over-ridding of the standard configuration for a specific app within a specific team/namespace
    - folder structure - ```user-config/$SHP_TEAM_NAME/$APP_NAME```
    - currently supports - ```instance_count```, ```container_port```, ```service_port```


### ```autogen-config``` items

* ```env-config``` folder
  * contains team-level / namespace-level configuration
  * key parameters are kubernetes namespace and sub-domain values
  * configuration generated by script - ensures automation
  * also supports overriding the docker registry and cluster base domain name
  * example config
    * base-config
    ```
    shp_docker_registry="docker.registry.hsbc"
    k8s_namespace=play
    app_subdomain=play
    ```
    * env.-specific config (local)
    ```
    shp_base_domain="local.service.platform"
    shp_docker_registry="docker.for.mac.host.internal:5000"
    ```


* ```kube-yamls``` folder
  * contains the application specific kubernetes deployment, service and ingress configuration on a per team/namespace basis
  * ensure that the same app codebase can be reused to deploy their independent instances
  * configuration generated automatically via cli scripts - ensures automation
  * apps deployed to the team namespace
  * apps provided route within the team sub-domain
    * {app_name}.{team_subdomain}.{kube_cluster_domain}
    * e.g. ```platform-example-spring.play.local.service.platform```
